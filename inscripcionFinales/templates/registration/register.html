{% extends 'base/base.html' %}

{% block title %}Registro de usuario{% endblock %}

{% block content %}

{% if request.user.is_staff or request.user.is_superuser or request.user.admin %}

<div id="registracion">  
    <form method="POST" class="form" id="registroForm">
        <div class="reg-rectangulo1">
            <p class = "text-center reg-title">
              Completar los siguientes campos:
            </p>
            {% csrf_token %}

            {% if form.errors %}
            <div id="register-error">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  <p>No se pudo enviar el formulario. Verifique los datos por favor.</p>
                </div>
            </div>
            {% endif %}

            <!-- Contenedor de dos columnas -->
            <div class="form-columns">
                <!-- Columna Izquierda -->
                <div class="form-column-left">
                    <!-- Nombre de Usuario -->
                    <p class="campo-form">
                        <label for="id_username">Nombre de Usuario:</label>
                        <br>
                        {{ form.username }}
                        {% if form.username.errors %}
                        <div class="field-error">
                            {{form.username.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Nombre Completo -->
                    <p class="campo-form">
                        <label for="id_nombre_completo">Nombre Completo:</label>
                        <br>
                        {{ form.nombre_completo }}
                        {% if form.nombre_completo.errors %}
                        <div class="field-error">
                            {{form.nombre_completo.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- DNI -->
                    <p class="campo-form">
                        <label for="id_dni">DNI:</label>
                        <br>
                        {{ form.dni }}
                        {% if form.dni.errors %}
                        <div class="field-error">
                            {{form.dni.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Email -->
                    <p class="campo-form">
                        <label for="id_email">Email:</label>
                        <br>
                        {{ form.email }}
                        {% if form.email.errors %}
                        <div class="field-error">
                            El email ya existe.
                        </div>
                        {%endif%}
                    </p>

                    <!-- Fecha de Nacimiento -->
                    <p class="campo-form">
                        <label for="id_fecha_nac">Fecha de nacimiento:</label>
                        <br>
                        {{ form.fecha_nac }}
                        {% if form.fecha_nac.errors %}
                        <div class="field-error">
                            {{form.fecha_nac.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Dirección -->
                    <p class="campo-form">
                        <label for="id_direccion">Dirección:</label>
                        <br>
                        {{ form.direccion }}
                        {% if form.direccion.errors %}
                        <div class="field-error">
                            {{form.direccion.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Localidad -->
                    <p class="campo-form">
                        <label for="id_localidad">Localidad:</label>
                        <br>
                        {{ form.localidad }}
                        {% if form.localidad.errors %}
                        <div class="field-error">
                            {{form.localidad.errors}}
                        </div>
                        {%endif%}
                    </p>
                </div>

                <!-- Columna Derecha -->
                <div class="form-column-right">
                    <!-- Ciudad -->
                    <p class="campo-form">
                        <label for="id_ciudad">Ciudad:</label>
                        <br>
                        {{ form.ciudad }}
                        {% if form.ciudad.errors %}
                        <div class="field-error">
                            {{form.ciudad.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Nacionalidad -->
                    <p class="campo-form">
                        <label for="id_nacionalidad">Nacionalidad:</label>
                        <br>
                        {{ form.nacionalidad }}
                        {% if form.nacionalidad.errors %}
                        <div class="field-error">
                            {{form.nacionalidad.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Teléfono -->
                    <p class="campo-form">
                        <label for="id_telefono_1">Teléfono:</label>
                        <br>
                        {{ form.telefono_1 }}
                        {% if form.telefono_1.errors %}
                        <div class="field-error">
                            {{form.telefono_1.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Celular -->
                    <p class="campo-form">
                        <label for="id_telefono_2">Celular:</label>
                        <br>
                        {{ form.telefono_2 }}
                        {% if form.telefono_2.errors %}
                        <div class="field-error">
                            {{form.telefono_2.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Estado Civil -->
                    <p class="campo-form">
                        <label for="id_estado_civil">Estado civil:</label>
                        <br>
                        {{ form.estado_civil }}
                        {% if form.estado_civil.errors %}
                        <div class="field-error">
                            {{form.estado_civil.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Sexo -->
                    <p class="campo-form">
                        <label for="id_sexo">Sexo:</label>
                        <br>
                        {{ form.sexo }}
                        {% if form.sexo.errors %}
                        <div class="field-error">
                            {{form.sexo.errors}}
                        </div>
                        {%endif%}
                    </p>

                    <!-- Carrera -->
                    <p class="campo-form">
                      <label for="id_carrera">Carrera:</label>
                      <br>
                      {{ form.carrera }}
                      {% if form.carrera.errors %}
                      <div class="field-error">
                          {{form.carrera.errors}}
                      </div>
                      {%endif%}
                    </p>
                </div>
            </div>

            <!-- Campos que van en ancho completo -->
            <div class="form-full-width">
                <!-- Rol -->
                <p class="campo-form">
                  <label for="id_rol">Rol:</label>
                  <br>
                  {{ form.rol }}
                  {% if form.rol.errors %}
                  <div class="field-error">
                      {{form.rol.errors}}
                  </div>
                  {%endif%}
                </p>

                <!-- Campos condicionales según el rol -->
                {% if form.rol.value == 'estudiante' %}
                    <p class="campo-form campo-condicional" id="matricula-field">
                        <label for="id_matricula">Matrícula:</label>
                        <br>
                        {{ form.matricula }}
                    </p>
                {% elif form.rol.value == 'profesor' %}
                    <p class="campo-form campo-condicional" id="especialidad-field">
                        <label for="id_especialidad">Especialidad:</label>
                        <br>
                        {{ form.especialidad }}
                    </p>
                {% elif form.rol.value == 'directivo' %}
                    <p class="campo-form campo-condicional" id="cargo-field">
                        <label for="id_cargo">Cargo:</label>
                        <br>
                        {{ form.cargo }}
                    </p>
                {% elif form.rol.value == 'preceptor' %}
                    <p class="campo-form campo-condicional" id="area-field">
                        <label for="id_area">Área:</label>
                        <br>
                        {{ form.area }}
                    </p>
                {% endif %}
            </div>
        </div>

        <div class="reg-rectangulo2">
            <div class="logo-registracion only-lt">
                <img src="/static/imagenes/SIMEF.png" class="logo-reg only-lt" style="width: 300px;height: 320px;">
            </div>
            <div class="botones-registracion">
              <button type="submit" class="btn btn-blue fs-6" style="transition: 0.6s">Registrar</button>
               <div id="volver_usuario">
              <a class="fs-5" href="/user_list/" style="text-decoration: none">Volver a Usuarios</a>
              </div>
            </div>
        </div>   
    </form>  
</div>

<style>
/* Contenedor de las dos columnas */
.form-columns {
    display: flex;
    gap: 20px;
    width: 100%;
}

.form-column-left,
.form-column-right {
    flex: 1;
    min-width: 0; /* Para que funcione correctamente el flex */
}

/* Campos de ancho completo */
.form-full-width {
    width: 100%;
    margin-top: 10px;
}

/* Estilos para los campos del formulario */
.campo-form {
    margin-bottom: 10px;
    text-align: center;
}

.campo-condicional {
    display: none;
}

.error-field {
    border: 2px solid #dc3545 !important;
    background-color: #f8d7da !important;
}

.success-field {
    border: 2px solid #28a745 !important;
    background-color: #d4edda !important;
}

/* Estilos para errores de campo más compactos */
.field-error {
    color: #dc3545;
    font-size: 12px;
    margin-top: 2px;
    text-align: center;
}

/* Inputs más pequeños */
.campo-form input,
.campo-form select {
    width: 100%;
    max-width: 200px;
    font-size: 14px;
    padding: 5px;
}

/* Estilos responsive */
@media only screen and (max-width: 900px) {
    .form-columns {
        flex-direction: column;
        gap: 0;
    }
    
    .form-column-left,
    .form-column-right {
        width: 100%;
    }
}

@media only screen and (max-width: 600px) {
  .reg-rectangulo1 {
          width: 95%;
          margin-left: 8%;
          margin-top: 0%;
        }
   .text-center {
    font-size: 15px;
   }
   .campo-form {
    margin-bottom: 8px;
   }
   .campo-form input,
   .campo-form select {
    max-width: 100%;
   }
   body {
    overflow-y: auto !important;
  }
  .form {
    padding-bottom: 85px;
  }
}

/* Estilos para alertas personalizadas */
.custom-alert {
    padding: 10px 15px;
    margin: 10px 0;
    border: 1px solid transparent;
    border-radius: 4px;
    position: relative;
}

.custom-alert.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.custom-alert.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.custom-alert.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registroForm');
    const usernameField = document.getElementById('id_username');
    const nombreField = document.getElementById('id_nombre_completo');
    const dniField = document.getElementById('id_dni');
    const fechaNacField = document.getElementById('id_fecha_nac');
    const direccionField = document.getElementById('id_direccion');
    const localidadField = document.getElementById('id_localidad');
    const ciudadField = document.getElementById('id_ciudad');
    const nacionalidadField = document.getElementById('id_nacionalidad');
    const emailField = document.getElementById('id_email');
    const telefono1Field = document.getElementById('id_telefono_1');
    const telefono2Field = document.getElementById('id_telefono_2');
    const estadoCivilField = document.getElementById('id_estado_civil');
    const sexoField = document.getElementById('id_sexo');
    const rolField = document.getElementById('id_rol');
    const carreraField = document.getElementById('id_carrera');
    
    // Campos condicionales
    const especialidadField = document.getElementById('id_especialidad');
    const cargoField = document.getElementById('id_cargo');
    const areaField = document.getElementById('id_area');

    // Función para mostrar alertas personalizadas
    function showAlert(message, type = 'danger', duration = 5000) {
        // Remover alertas existentes
        const existingAlerts = document.querySelectorAll('.custom-alert');
        existingAlerts.forEach(alert => alert.remove());

        const alertDiv = document.createElement('div');
        alertDiv.className = `custom-alert alert-${type}`;
        alertDiv.innerHTML = `
            <strong>${type === 'danger' ? 'Error:' : type === 'success' ? 'Éxito:' : 'Atención:'}</strong> ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove();" style="float: right;">&times;</button>
        `;
        
        const formContainer = document.querySelector('.reg-rectangulo1');
        formContainer.insertBefore(alertDiv, formContainer.children[2]); // Después del título y csrf
        
        // Auto-remover después del tiempo especificado
        if (duration > 0) {
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, duration);
        }
    }

    // Función para validar DNI
    function validateDNI(dni) {
        const dniRegex = /^[0-9]{7,8}$/;
        return dniRegex.test(dni);
    }

    // Función para validar email
    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Función para validar nombre completo
    function validateNombre(nombre) {
        const nombreRegex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]{2,100}$/;
        return nombreRegex.test(nombre.trim());
    }

    // Función para validar teléfonos
    function validateTelefono(telefono) {
        const telefonoRegex = /^[0-9]{6,15}$/;
        return telefonoRegex.test(telefono);
    }

    // Función para validar fecha de nacimiento
    function validateFechaNac(fecha) {
        if (!fecha) return true; // Campo opcional
        const hoy = new Date();
        const fechaNac = new Date(fecha);
        const edad = hoy.getFullYear() - fechaNac.getFullYear();
        return edad >= 16 && edad <= 100; // Rango razonable de edad
    }

    // Función para agregar/quitar clases de error
    function toggleFieldError(field, hasError) {
        if (!field) return;
        if (hasError) {
            field.classList.add('error-field');
            field.classList.remove('success-field');
        } else {
            field.classList.remove('error-field');
            field.classList.add('success-field');
        }
    }

    // Validaciones en tiempo real para DNI
    if (dniField) {
        dniField.addEventListener('blur', function() {
            const dni = this.value.trim();
            if (dni && !validateDNI(dni)) {
                toggleFieldError(this, true);
                showAlert('El DNI debe contener entre 7 y 8 números.', 'danger', 3000);
            } else if (dni) {
                toggleFieldError(this, false);
            }
        });

        dniField.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }

    // Validación en tiempo real para email
    if (emailField) {
        emailField.addEventListener('blur', function() {
            const email = this.value.trim();
            if (email && !validateEmail(email)) {
                toggleFieldError(this, true);
                showAlert('Por favor ingrese un email válido.', 'danger', 3000);
            } else if (email) {
                toggleFieldError(this, false);
            }
        });
    }

    // Validación en tiempo real para nombre completo
    if (nombreField) {
        nombreField.addEventListener('blur', function() {
            const nombre = this.value.trim();
            if (nombre && !validateNombre(nombre)) {
                toggleFieldError(this, true);
                showAlert('El nombre debe contener solo letras y tener entre 2 y 100 caracteres.', 'danger', 3000);
            } else if (nombre) {
                toggleFieldError(this, false);
            }
        });
    }

    // Validación para teléfonos
    if (telefono1Field) {
        telefono1Field.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        telefono1Field.addEventListener('blur', function() {
            const telefono = this.value.trim();
            if (telefono && !validateTelefono(telefono)) {
                toggleFieldError(this, true);
                showAlert('El teléfono debe contener entre 6 y 15 números.', 'danger', 3000);
            } else if (telefono) {
                toggleFieldError(this, false);
            }
        });
    }

    if (telefono2Field) {
        telefono2Field.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        telefono2Field.addEventListener('blur', function() {
            const telefono = this.value.trim();
            if (telefono && !validateTelefono(telefono)) {
                toggleFieldError(this, true);
                showAlert('El celular debe contener entre 6 y 15 números.', 'danger', 3000);
            } else if (telefono) {
                toggleFieldError(this, false);
            }
        });
    }

    if (fechaNacField) {
        fechaNacField.addEventListener('blur', function() {
            const fecha = this.value;
            if (fecha && !validateFechaNac(fecha)) {
                toggleFieldError(this, true);
                showAlert('La fecha de nacimiento debe corresponder a una edad entre 16 y 100 años.', 'danger', 3000);
            } else if (fecha) {
                toggleFieldError(this, false);
            }
        });
    }

    // Función para mostrar/ocultar campos según el rol
    function toggleFieldsBasedOnRole() {
        const rol = rolField.value.toLowerCase();
        
        // Ocultar todos los campos condicionales
        const camposCondicionales = document.querySelectorAll('.campo-condicional');
        camposCondicionales.forEach(campo => {
            campo.style.display = 'none';
        });

        // Mostrar el campo correspondiente al rol seleccionado
        if (rol === 'estudiante') {
            const matriculaField = document.getElementById('matricula-field');
            if (matriculaField) matriculaField.style.display = 'block';
        } else if (rol === 'profesor') {
            const especialidadField = document.getElementById('especialidad-field');
            if (especialidadField) especialidadField.style.display = 'block';
        } else if (rol === 'directivo') {
            const cargoField = document.getElementById('cargo-field');
            if (cargoField) cargoField.style.display = 'block';
        } else if (rol === 'preceptor') {
            const areaField = document.getElementById('area-field');
            if (areaField) areaField.style.display = 'block';
        }
    }

    // Event listener para cambios en el rol
    if (rolField) {
        rolField.addEventListener('change', toggleFieldsBasedOnRole);
        // Ejecutar al cargar la página
        toggleFieldsBasedOnRole();
    }

    // Validación completa del formulario antes de enviar
    form.addEventListener('submit', function(e) {
        let hasErrors = false;
        const errors = [];

        // Validar campos obligatorios
        if (nombreField && !nombreField.value.trim()) {
            errors.push('El nombre completo es obligatorio.');
            toggleFieldError(nombreField, true);
            hasErrors = true;
        } else if (nombreField && !validateNombre(nombreField.value.trim())) {
            errors.push('El nombre debe contener solo letras.');
            toggleFieldError(nombreField, true);
            hasErrors = true;
        }

        if (!dniField.value.trim()) {
            errors.push('El DNI es obligatorio.');
            toggleFieldError(dniField, true);
            hasErrors = true;
        } else if (!validateDNI(dniField.value.trim())) {
            errors.push('El DNI debe contener entre 7 y 8 números.');
            toggleFieldError(dniField, true);
            hasErrors = true;
        }

        if (!emailField.value.trim()) {
            errors.push('El email es obligatorio.');
            toggleFieldError(emailField, true);
            hasErrors = true;
        } else if (!validateEmail(emailField.value.trim())) {
            errors.push('Ingrese un email válido.');
            toggleFieldError(emailField, true);
            hasErrors = true;
        }

        if (!rolField.value) {
            errors.push('Debe seleccionar un rol.');
            toggleFieldError(rolField, true);
            hasErrors = true;
        }

        // Validar fecha de nacimiento si está presente
        if (fechaNacField && fechaNacField.value && !validateFechaNac(fechaNacField.value)) {
            errors.push('Edad debe estar entre 16 y 100 años.');
            toggleFieldError(fechaNacField, true);
            hasErrors = true;
        }

        // Validar teléfonos si están presentes
        if (telefono1Field && telefono1Field.value.trim() && !validateTelefono(telefono1Field.value.trim())) {
            errors.push('Teléfono debe tener entre 6 y 15 números.');
            toggleFieldError(telefono1Field, true);
            hasErrors = true;
        }

        if (telefono2Field && telefono2Field.value.trim() && !validateTelefono(telefono2Field.value.trim())) {
            errors.push('Celular debe tener entre 6 y 15 números.');
            toggleFieldError(telefono2Field, true);
            hasErrors = true;
        }

        // Validar campos condicionales según el rol
        const rolSeleccionado = rolField.value.toLowerCase();
        if (rolSeleccionado === 'profesor' && especialidadField && !especialidadField.value.trim()) {
            errors.push('La especialidad es obligatoria para profesores.');
            toggleFieldError(especialidadField, true);
            hasErrors = true;
        }
        if (rolSeleccionado === 'directivo' && cargoField && !cargoField.value.trim()) {
            errors.push('El cargo es obligatorio para directivos.');
            toggleFieldError(cargoField, true);
            hasErrors = true;
        }
        if (rolSeleccionado === 'preceptor' && areaField && !areaField.value.trim()) {
            errors.push('El área es obligatoria para preceptores.');
            toggleFieldError(areaField, true);
            hasErrors = true;
        }

        // Si hay errores, prevenir el envío y mostrar alertas
        if (hasErrors) {
            e.preventDefault();
            showAlert('Corrija los errores: ' + errors.join(' '), 'danger', 8000);
            
            // Scroll al primer campo con error
            const firstErrorField = document.querySelector('.error-field');
            if (firstErrorField) {
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstErrorField.focus();
            }
        } else {
            // Si todo está bien, mostrar mensaje de éxito
            showAlert('Registrando usuario...', 'success', 2000);
        }
    });

    // Limpiar clases de error cuando el usuario empiece a corregir
    const allFields = [usernameField, nombreField, dniField, fechaNacField, direccionField, 
                      localidadField, ciudadField, nacionalidadField, emailField, 
                      telefono1Field, telefono2Field, estadoCivilField, sexoField, 
                      rolField, carreraField];
    
    allFields.forEach(field => {
        if (field) {
            field.addEventListener('input', function() {
                if (this.classList.contains('error-field')) {
                    this.classList.remove('error-field');
                }
            });
        }
    });
});
</script>

{% else %}

<div class="card">
  <h3>Ud no tiene los permisos para acceder a esta página</h3>
<div class="text-center">
    <img src="/static/imagenes/error403.png" class=""></img>
  <h3>No deberías estar acá. Para volver, <a href="/">hace click acá</a></h3>
</div>
</div>

{%endif%}

{% endblock %}